{% extends 'base.html' %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<h1>Admin Dashboard</h1>

{#<form method="post" action="{{ url_for('admin.approve_all_reports') }}" class="mb-3">#}
{#  <button type="submit" class="btn btn-success btn-sm"#}
{#          onclick="return confirm('Approve ALL pending reports?');">#}
{#    Approve All Pending#}
{#  </button>#}
{#</form>#}
<!-- Trigger: does NOT submit; just opens the modal -->
<button type="button"
        class="btn btn-success btn-sm mb-3"
        data-bs-toggle="modal"
        data-bs-target="#approveAllModal">
  Approve All Pending
</button>

<!-- Modal: blocks background, requires a choice -->
<div class="modal fade"
     id="approveAllModal"
     tabindex="-1"
     aria-labelledby="approveAllLabel"
     aria-hidden="true"
     data-bs-backdrop="static"
     data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="approveAllLabel">Approve All Pending Reports</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <p class="mb-0">
          This will change the status of
          <strong>{{ pending|length }}</strong>
          report(s) from <em>Open/In Review</em> to <strong>Approved</strong>.
          Are you sure you want to continue?
        </p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>

        <!-- The form lives in the modal so Confirm actually POSTs -->
        <form method="post" action="{{ url_for('admin.approve_all_reports') }}" class="d-inline">
          <button type="submit" class="btn btn-success">Confirm Approve All</button>
        </form>
      </div>
    </div>
  </div>
</div>


<h2>Pending Reports</h2>
{% if pending %}
  <table class="table-simple">
    <tr>
      <th>ID</th><th>Title</th><th>Author</th><th>Status</th><th>Actions</th>
    </tr>
    {% for p in pending %}
      <tr>
        <td>{{ p['id'] }}</td>
        <td>{{ p['title'] }}</td>
        <td>{{ p['username'] }}</td>
        <td>{{ p['status'] }}</td>
        <td>
          <form method="post" action="{{ url_for('admin.approve_report', rid=p['id']) }}" style="display:inline">
            <button type="submit">Approve</button>
          </form>
          <form method="post" action="{{ url_for('admin.reject_report', rid=p['id']) }}" style="display:inline">
            <button type="submit">Reject</button>
          </form>
          <form method="post" action="{{ url_for('admin.delete_report', rid=p['id']) }}" style="display:inline">
            <button type="submit" onclick="return confirm('Delete this report?')">Delete</button>
          </form>
        </td>
      </tr>
    {% endfor %}
  </table>
{% else %}
  <p>No pending reports.</p>
{% endif %}

<hr>

<h2>Users</h2>
<table class="table-simple">
  <tr>
    <th>ID</th><th>Username</th><th>Name</th><th>Email</th><th>Role</th><th>Change Role</th>
  </tr>
  {% for u in users %}
    <tr>
      <td>{{ u['id'] }}</td>
      <td>{{ u['username'] }}</td>
      <td>{{ (u['first_name'] or '') ~ ' ' ~ (u['last_name'] or '') }}</td>
      <td>{{ u['email_address'] or '' }}</td>
      <td>{{ u['role'] }}</td>
      <td>
        <form method="post" action="{{ url_for('admin.change_role', uid=u['id']) }}">
          <select name="role">
            <option value="user" {{ 'selected' if u['role']=='user' else '' }}>user</option>
            <option value="admin" {{ 'selected' if u['role']=='admin' else '' }}>admin</option>
          </select>
          <button type="submit">Update</button>
        </form>
      </td>
    </tr>
  {% endfor %}
</table>
{% endblock %}